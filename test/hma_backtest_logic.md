# HMA Mantra 백테스트 로직 설명

## 개요

HMA Mantra 백테스트 시스템은 코스탈라니 달걀모형 기반의 경제 사이클 분석 및 주식 매수 신호의 실효성을 검증하는 자동화된 백테스트 도구입니다.

### 목적
- HMA Mantra 전략의 매수 신호가 실제로 유효한지 검증
- 매수 신호 발생 시 USD 1,000씩 고정 매수하여 성과 분석
- 다양한 보유 기간별 수익률 및 수익금 분석

### 핵심 특징
1. **고정 매수 전략**: 매 신호마다 동일한 금액(USD 1,000) 투자
2. **다중 기간 분석**: 1/3/6개월, 현재까지의 성과를 모두 분석
3. **벤치마크 비교**: S&P 500 대비 상대적 성과 평가
4. **신호 타당성**: 각 신호의 품질을 객관적으로 평가
5. **포괄적 분석**: 수익률뿐만 아니라 실제 수익금까지 계산

## 백테스트 프로세스

### 1. 데이터 로드 단계

```python
def load_data(self):
```

**주요 기능:**
- **주식 데이터**: yfinance를 통해 지정된 종목의 일별 데이터 로드
- **벤치마크**: S&P 500 (^GSPC) 데이터 로드
- **VIX 데이터**: 변동성지수 (^VIX) 데이터 로드
- **기간 조정**: 2년 → 1년 → 6개월 순으로 데이터 가용성 확인

**데이터 로드 우선순위:**
1. 2년 데이터 (24mo)
2. 1년 데이터 (12mo) - 2년 데이터 없을 시
3. 6개월 데이터 (6mo) - 1년 데이터도 없을 시

### 2. 매수 신호 생성

```python
def generate_signals(self):
```

**신호 로직:**
- **신호 소스**: `src.indicators.hma_mantra.signals.get_hma_mantra_md_signals()` 사용
- **복합 신호**: HMA, 만트라 밴드, RSI, MACD를 조합한 신호
- **필터링**: 매수 신호(BUY)만 추출

**신호 구성 요소:**
- **HMA (Hull Moving Average)**: 빠른 이동평균선
- **만트라 밴드**: 변동성 기반 밴드
- **RSI (Relative Strength Index)**: 상대강도지수
- **MACD**: 이동평균수렴확산지수

### 3. 수익률 계산 로직

```python
def calculate_returns(self, buy_date, buy_price, hold_periods=[30, 90, 180]):
```

**각 보유 기간별 수익률 계산:**

| 기간 | 일수 | 설명 |
|------|------|------|
| 1개월 | 30일 | 매수 후 30일 후 가격으로 수익률 계산 |
| 3개월 | 90일 | 매수 후 90일 후 가격으로 수익률 계산 |
| 6개월 | 180일 | 매수 후 180일 후 가격으로 수익률 계산 |
| 현재까지 | - | 최신 가격으로 현재까지 수익률 계산 |

**수익률 공식:**
```
수익률(%) = (매도가격 - 매수가격) / 매수가격 × 100
```

### 4. 벤치마크 비교

```python
def calculate_benchmark_returns(self, buy_date, hold_periods=[30, 90, 180]):
```

**벤치마크 분석:**
- **S&P 500 대비 성과**: 동일한 기간 동안 S&P 500 수익률과 비교
- **상대적 성과 평가**: 개별 종목이 시장 대비 얼마나 우수한지 판단
- **시장 대비 성과**: 벤치마크 대비 초과 수익률 계산

### 5. 신호 타당성 평가

```python
def evaluate_signal(self, returns, benchmark_returns):
```

**평가 기준 (6개월 수익률 기준):**

| 등급 | 조건 | 설명 |
|------|------|------|
| 우수 | 벤치마크 대비 5% 이상 우수 | 매우 좋은 신호 |
| 양호 | 벤치마크 대비 우수 | 좋은 신호 |
| 보통 | 양의 수익률 | 보통 수준의 신호 |
| 불량 | 손실 | 나쁜 신호 |

### 6. 투자 성과 분석

**수익금 계산:**
```python
수익금 = 매수수량 × 매수가격 × (수익률 / 100)
매수수량 = 매수금액 / 매수가격
```

**요약 통계 항목:**

| 구분 | 설명 |
|------|------|
| 평균 수익률 | 각 기간별 평균 수익률 |
| 평균 수익금 | 각 기간별 평균 수익금 |
| 총 수익금 | 각 기간별 총 수익금 |
| 승률 | 각 기간별 수익 발생 비율 |

**투자기간별 요약:**
- **총 투자금액** = 신호 수 × 매수금액
- **총 수익금** = 모든 신호의 수익금 합계
- **투자수익률** = (총 수익금 / 총 투자금액) × 100

## 결과 출력 및 저장

### 저장 파일 구조

```
test/backtest_results/{종목코드}/
├── {종목코드}_backtest_detailed.csv    # 상세 결과
├── {종목코드}_backtest_summary.md      # 요약 결과 (마크다운)
└── {종목코드}_backtest_results.png     # 시각화 (히스토그램)
```

### 상세 결과 CSV 파일

**포함 컬럼:**
- 매수 신호 발생일
- 매수 가격
- 매수 금액
- 매수 수량
- **VIX 지수** (매수일 기준)
- 1개월/3개월/6개월/현재까지 수익률(%)
- 1개월/3개월/6개월/현재까지 수익금
- 벤치마크 1개월/3개월/6개월 수익률(%)
- 신호 타당성 평가

### 요약 결과 마크다운 파일

**포함 섹션:**
1. **요약 통계**: 평균 VIX 지수, 평균 수익률, 평균 수익금, 총 수익금, 승률
2. **투자기간별 요약**: 총 투자금액, 총 수익금, 투자수익률
3. **상세 결과**: 모든 신호별 상세 정보

### 시각화 (히스토그램)

**포함 차트:**
- 각 기간별 수익률 분포 히스토그램
- 각 기간별 수익금 분포 히스토그램
- **VIX 지수 분포 히스토그램**
- **VIX vs 수익률 산점도** (6개월, 현재까지)
- **신호 타당성 평가 분포** (막대 차트)
- 평균선 표시 및 상관계수 계산

## 실행 방법

### 명령어 형식
```bash
python hma_backtest_program.py <종목코드> [기간] [매수금액]
```

### 매개변수 설명

| 매개변수 | 설명 | 기본값 | 예시 |
|----------|------|--------|------|
| 종목코드 | 분석할 주식 심볼 | 필수 | TSLA, AAPL, SMR |
| 기간 | 백테스트 기간 | 24mo | 12mo, 6mo |
| 매수금액 | 매 신호당 투자 금액 | 1000 | 500, 2000 |

### 실행 예시
```bash
# 기본 설정으로 TSLA 백테스트
python hma_backtest_program.py TSLA

# 1년 기간, USD 500 매수로 SMR 백테스트
python hma_backtest_program.py SMR 12mo 500

# 6개월 기간, USD 2000 매수로 AAPL 백테스트
python hma_backtest_program.py AAPL 6mo 2000
```

## 경제 사이클 연관성

### 코스탈라니 달걀모형 기반 분석

HMA Mantra 전략은 경제 사이클의 다음 단계에서 매수 신호를 생성합니다:

1. **B 단계 (Boom)**: 호황기 - 매수 신호 발생
2. **C 단계 (Crash)**: 폭락기 - 매수 신호 발생
3. **E 단계 (Economic Depression)**: 불황기 - 매수 신호 발생
4. **B→C 전환**: 호황에서 폭락으로 전환 시 - 매수 신호 발생

### 거시경제 지표 활용

백테스트 시스템은 다음 거시경제 지표를 고려합니다:
- **GDP**: 국내총생산
- **인플레이션**: 물가상승률
- **금리**: 기준금리
- **실업률**: 고용지표
- **VIX**: 변동성지수
- **DXY**: 달러지수

## 성과 평가 지표

### 주요 성과 지표

1. **수익률 지표**
   - 평균 수익률 (각 기간별)
   - 최대 수익률
   - 최소 수익률
   - 수익률 표준편차

2. **수익금 지표**
   - 평균 수익금 (각 기간별)
   - 총 수익금
   - 투자수익률 (ROI)

3. **승률 지표**
   - 각 기간별 승률
   - 전체 승률

4. **벤치마크 대비 성과**
   - 벤치마크 대비 초과 수익률
   - 벤치마크 대비 승률

5. **VIX 지표**
   - 평균 VIX 지수
   - 최소 VIX 지수
   - 최대 VIX 지수
   - VIX vs 수익률 상관계수

### 신호 품질 평가

- **우수 신호 비율**: 전체 신호 중 우수 등급 비율
- **불량 신호 비율**: 전체 신호 중 불량 등급 비율
- **신호 빈도**: 기간별 매수 신호 발생 빈도

## 활용 방법

### 1. 전략 검증
- HMA Mantra 전략의 실효성 검증
- 다양한 시장 환경에서의 성과 분석
- 전략 개선을 위한 데이터 기반 의사결정

### 2. 종목별 분석
- 개별 종목의 매수 시점 최적화
- 종목별 특성에 따른 성과 차이 분석
- 포트폴리오 구성 최적화

### 3. 시장 환경별 분석
- 경제 사이클별 성과 분석
- 시장 변동성에 따른 성과 차이
- 거시경제 지표와의 상관관계 분석

## 주의사항

### 백테스트 한계
1. **과거 데이터 기반**: 미래 성과를 보장하지 않음
2. **거래 비용 미고려**: 수수료, 슬리피지 등 미반영
3. **유동성 가정**: 실제 거래 시 유동성 제약 미고려
4. **시장 충격 미고려**: 대량 매수 시 시장 충격 미반영

### 해석 시 고려사항
1. **샘플 크기**: 신호 수가 적을 경우 통계적 유의성 부족
2. **시장 환경 변화**: 과거와 다른 시장 환경에서 성과 차이 가능
3. **전략 진화**: 시장이 전략을 학습하여 성과 저하 가능

## 결론

HMA Mantra 백테스트 시스템은 코스탈라니 달걀모형 기반의 경제 사이클 분석을 통해 생성된 매수 신호의 실효성을 종합적으로 검증하는 도구입니다. 

다양한 보유 기간별 수익률과 수익금 분석, 벤치마크 대비 성과 평가, 신호 타당성 분석을 통해 투자 의사결정에 필요한 객관적인 데이터를 제공합니다.

이 시스템을 통해 HMA Mantra 전략의 실효성을 검증하고, 전략 개선 및 포트폴리오 최적화에 활용할 수 있습니다. 